# カード管理ガイド

## 概要

Flowwでは、**ユーザーが選択したクレジットカード会社のみ**から利用通知メールを取得します。プランに応じて登録できるカード会社の数が変わります。

## 機能

### 1. カード会社の選択

`/cards` ページで対応カード会社を選択できます。

**対応カード会社（例）:**
- 楽天カード
- 三井住友カード
- JCBカード
- イオンカード
- エポスカード
- dカード
- au PAYカード
- セゾンカード
- オリコカード
- ビューカード
- PayPayカード
- American Express
- その他 (Visa/Mastercard)

### 2. 自動メール取得

選択したカード会社のメールアドレス（ドメインまたはキーワード）から送信されたメールを自動的に取得します。

**取得されるメール:**
- ✅ ユーザーが選択したカード会社からの利用通知**のみ**
- ❌ Amazon・楽天・Yahoo等のショッピングサイトは**選択した場合のみ**取得

### 3. クエリの仕組み

#### クエリ生成ロジック

```typescript
// sync-emails-v2/route.ts の buildEmailQuery() 関数
async function buildEmailQuery(supabase: any, userId: string): Promise<string> {
  // 1. ユーザーが選択したカード会社のクエリを取得
  const userIssuers = await getUserCardIssuers(userId)

  // 2. カード会社が選択されていない場合はエラー
  if (!userIssuers || userIssuers.length === 0) {
    return 'newer_than:90d subject:"カード利用のお知らせ"' // 制限的なフォールバック
  }

  // 3. カード会社のメールドメイン/キーワードから検索クエリを生成
  // 例: from:rakuten-card.co.jp OR from:"楽天カード"

  // 4. 日付フィルタを追加（過去90日）
  // 例: newer_than:90d
}
```

#### 実際のクエリ例

**ユーザーが「楽天カード」と「三井住友カード」のみを選択した場合:**

```
(
  from:rakuten-card.co.jp OR from:"楽天カード" OR
  from:smbc-card.com OR from:"三井住友" OR from:"SMBC"
) newer_than:90d
```

**重要:** Amazon・楽天市場などのショッピングサイトは、ユーザーが明示的にカード会社として追加しない限り取得されません。

## データベース構造

### テーブル

1. **`card_issuers`** - カード会社マスタ
   - `name`: カード会社名
   - `email_domain`: メールドメイン（例: `rakuten-card.co.jp`）
   - `email_keywords`: 検索キーワード配列（例: `['楽天カード', 'Rakuten Card']`）

2. **`user_card_issuers`** - ユーザーが選択したカード会社
   - `user_id`: ユーザーID
   - `issuer_id`: カード会社ID

3. **`credit_cards`** - ユーザーの登録カード
   - `card_last4`: カード下4桁（**任意** - 精度向上のため推奨）
   - `issuer_id`: カード会社ID
   - `nickname`: ニックネーム

## 使い方

### ステップ1: カード会社を選択

1. `/cards` ページに移動
2. 「対応カード会社」セクションでカード会社をクリック
3. 選択されたカード会社にチェックマークが表示される

### ステップ2: メール同期

1. ダッシュボードで「同期」ボタンをクリック
2. 選択したカード会社からのメールが自動的に取得される
3. 取引データが自動的に抽出・保存される

### ステップ3: カードの登録（オプション）

1. `/cards` ページで「カードを追加」をクリック
2. カード下4桁、ニックネーム、カード会社を入力
3. 登録したカードごとに支出を追跡できる

## 変更履歴

### 2025-10-01 (v2)
- ✅ **重要:** Amazon/楽天のデフォルト取得を削除 - ユーザー選択カードのみ取得
- ✅ カード下4桁を任意に変更（精度向上のため入力推奨）
- ✅ モーダル背景の改善（黒画面→透過ブラー）
- ✅ 空の状態でのUXガイド追加（ダッシュボード）
- ✅ カスタマージャーニーの改善

### 2025-10-01 (v1)
- ✅ メール取得件数を50件→500件に増加（3ヶ月分対応）
- ✅ クエリ生成ロジックを改善
- ✅ カード管理画面にヒントメッセージを追加

## トラブルシューティング

### Q: カード会社を選択したのにメールが取得されない

**A:** 以下を確認してください:
1. Gmail連携が正常に動作しているか
2. カード会社からのメールが実際に届いているか
3. メールの送信元が登録されているドメイン/キーワードと一致しているか

### Q: 特定のカード会社が対応リストにない

**A:** データベースに新しいカード会社を追加できます:

```sql
INSERT INTO public.card_issuers (name, email_domain, email_keywords) VALUES
  ('カード会社名', 'example.com', ARRAY['キーワード1', 'キーワード2']);
```

### Q: メール取得件数を変更したい

**A:** 以下のファイルの `maxResults` を変更してください:
- `app/lib/gmail-improved.ts` (line 51, 151)
- `app/lib/gmail.ts` (line 35)
- `app/api/sync-emails-v2/route.ts` (line 39)

## まとめ

- ✅ **ユーザーが選択したカード会社のみ**メールを取得
- ✅ プランに応じてカード会社の登録枚数制限あり（Free: 2社）
- ✅ カード下4桁は任意（入力すると精度向上）
- ✅ 過去90日分のメールを最大500件まで取得
- ✅ 初回ユーザー向けガイド完備
